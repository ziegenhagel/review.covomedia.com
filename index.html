<!DOCTYPE html>
<html>

<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div id="app">
        <header id="nav-top" class="is-dark mobile-not-collapsed">
            <div class="container"><a class="nolink"
                    :href="brand == 'ziegenhagel' ? 'https://ziegenhagel.com/' : 'https://www.guerillamedia-freiburg.de/'">
                    <div class="nav-left">
                        <img id="logo-anim" v-if="brand == 'ziegenhagel'" alt="Ziegenhagel Media Logo"
                            src="https://ziegenhagel.com/static/logo-49a4d0c39260add115bae97c1fbb3196.jpg">
                        <img id="logo-anim" v-else alt="Ziegenhagel Media Logo"
                            src="https://i2.wp.com/www.guerillamedia-freiburg.de/wp-content/uploads/2021/09/Laurin_Film_s-w-1-quadrat.jpg?resize=150%2C150&ssl=1">
                        <div class="nav-logo-text" v-if="brand == 'ziegenhagel'">Ziegenhagel <span
                                style="color: rgb(119, 119, 119);">Media</span></div>
                        <div class="nav-logo-text" v-else>guerillamedia</div>
                    </div>
                </a>
                <div class="nav-hamburger">
                    <div id="nav-icon2" class="closed">
                        <span></span><span></span><span></span><span></span><span></span><span></span>
                    </div>
                </div>
                <div class="nav-right"><a target="_blank"
                        :href="brand == 'ziegenhagel' ? 'https://ziegenhagel.com/support' : 'https://www.guerillamedia-freiburg.de/kontakt'">
                        Support</a></div>
            </div>
        </header>

        <div class="container" id="mainApp">
            <div class="row">
                <div class="explain" v-if="isExplainVisible">
                        <i class="fa fa-times close" @click="isExplainVisible=false"></i>
                    <div class="card-body">
                        <h4>Feedback für Optimierungsschleifen </h4>
                    </div>
                    <div class="card-body border-top">
                        <i class="fa fa-info-circle"></i> Hier können Sie Versionen Ihres Films in
                        geschützter Umgebung einsehen und kommentieren.
                        Unser Team aus der Postproduktion wird Ihre Kommentare
                        aufgreifen und gewünschte Änderungen vornehmen.
                        <br><br>
                        <i class="fa fa-info-circle"></i> Auf der linken Seite befindet sich der Player, auf der rechten
                        Seite sehen Sie die Kommentarspalte.
                        Sobald Sie beginnen, einen neuen Kommentar zu schreiben,
                        wird dieser automatisch mit der richtigen Stelle im Video verlinkt.
                    </div>
                </div>
                <div v-else><br></div>

                <div class="col">
                    <div class="sticky-desktop">

                        <div v-show="version_src" class="embed-responsive embed-responsive-16by9">
                            <div v-if="compare_version_id" class="compare_video_overlay">Version {{version_code}}</div>
                            <video autoplay class="embed-responsive-item" controls ref="player" style="max-width:100%"
                            onpause="document.getElementById('compare_player').pause()"
                            onseeked="document.getElementById('compare_player').currentTime=this.currentTime"
                            onplay="document.getElementById('compare_player').play()"
                            >
                                 <source :src="version_src" type="video/mp4">
                            </video>
                        </div>
                        <div v-show="compare_version_src" class="embed-responsive embed-responsive-16by9">
                            <div v-if="compare_version_id" class="compare_video_overlay">Vergleich Version {{compare_version_code}}</div>
                            <video id="compare_player" autoplay muted class="embed-responsive-item" ref="compare_player" style="max-width:100%">
                                 <source :src="compare_version_src" type="video/mp4">
                            </video>
                        </div>

                        <div id="info" class="card card-body has-i">
                            <h4><i class="fa fa-stopwatch"></i> Timecode: {{formatTime(time)}}</h4>
                        </div>
                        <div id="version-section" v-if="versions.length > 1" class="card">
                            <div class="card-body">
                                <h4> <i class="fa fa-history"></i> Versionen </h4>
                            </div>
                            <table class="table border-top">
                                <tr :class="version.id == version_id ? 'active' : ''"
                                    v-for="(version,index) in versions">
                                    <td>Version {{index+1}} </td>
                                    <td>{{version.changelog}}</td>
                                    <td>
                                        <i class="o5" v-if="version.id == version_id ? 'active' : ''">Aktuell ausgewählt</i>
                                        <a class="link" @click="setVersionId(version.id)" v-else>Anschauen ›</a>
                                    </td>
                                    <td>
                                        <a class="link" @click="setCompareVersionId(version.id)">Vergleichen ›</a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div id="comment-section">
                        <div class="card">
                            <div class="card-body">
                                <h4> <i class="fa fa-comment"></i> Feedback </h4>
                            </div>
                            <div class="card-body border-top">
                                <div style="margin-bottom:10px"> Kommentar an Stelle <span
                                        class="truetype">{{formatTime(add_comment.time)}}</span>  <span v-if="compare_version_id">in Version {{version_code}}</span><span v-else>im Video</span> hinterlassen.
                                </div>
                                <textarea autofocus="autofocus" :disabled="commentSubmitting" v-model="add_comment.text"
                                    class="form-control" v-on:keyup="stopVideo"
                                    placeholder="Kommentar zu aktueller Video Stelle eingeben"></textarea>
                                <input v-model="add_comment.author" :disabled="commentSubmitting" class="form-control"
                                    placeholder="Ihr Name">
                                <button @click="submit_comment" :class="commentSubmitting ? 'btn btn-primary disabled':'btn btn-primary'">
                                    <span class="spinner-border spinner-border-sm" v-if="commentSubmitting" role="status" aria-hidden="true"></span>
                                    Kommentar speichern <i class="fa fa-chevron-right"></i></button>
                            </div>

                        </div>

                        <div class="card card-comments">
                            <div class="card-body">
                                <h4> <i class="fa fa-list"></i> Kommentare </h4>
                            </div>
                            <div v-if="commentsLoading" style="margin:100px auto;border-top:none !important">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading ...</span>
                                </div>
                            </div>
                            <div v-else :class="comment.done == '1' ? ' bg-success text-white' : ''"
                                v-for="comment in comments" v-if="comment.done == '0' || !hideDoneComments">
                                <div class="card-body">
                                    <p class="card-text">
                                        <span v-if="comment.author.length > 1"><i class="fa fa-at"></i>
                                            <b>{{comment.author}}</b> -</span>
                                        {{comment.text}}
                                    </p>
                                    <button @click="seekTo(comment.time)" class="btn btn-info"><i
                                            class="fa fa-share"></i>
                                        Zu
                                        {{formatTime(comment.time)}}
                                        springen</button>
                                    <button v-if=" showEditLinks && comment.done == '0' && comment.id"
                                        @click="toggle_done(comment)" class="btn btn-success"><i
                                            class="fa fa-check"></i> Als Fertig markieren</button>
                                </div>
                            </div>
                            <div class="card-footer row">

                                <a style="cursor:pointer;text-decoration:none" class="o5-hover"
                                    @click="hideDoneComments=!hideDoneComments"> <i
                                        :class="!hideDoneComments ? 'fa fa-eye-slash':'fa fa-eye'"></i>
                                    {{hideDoneComments ? "Zeige fertige Kommentare an" : "Alle fertigen Kommentare ausblenden"}}</a>
                                <a style="cursor:pointer;text-decoration:none" class="o5-hover"
                                    @click="showEditLinks=!showEditLinks">
                                    <i :class="showEditLinks ? 'fa fa-eye-slash':'fa fa-eye'"></i>
                                    {{!showEditLinks ? "Bearbeitung einblenden" : "Bearbeitung ausblenden"}}</a>

                            </div>
                        </div>
                        <br>
                        <br>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const api_url = "https://api.covomedia.com/plug-review/"

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        let isSeeking = false

        // load infos provided by url
        let url_version_id = urlParams.get("version_id") 
        let url_brand = urlParams.get("brand")

        if(url_version_id === null) document.getElementById("mainApp").innerHTML=`<div id='error'><h1>Fehler.</h1><h5>Dieses Video konnte nicht gefunden werden.</h5>
            <a href='https://ziegenhagel.com' class='btn btn-primary-outline'><i class='fa fa-home'></i> Zur Startseite</a></div>`

        var app = new Vue({
            el: '#app',
            data: {
                brand: url_brand === null ? "ziegenhagel" : url_brand,
                version_id: url_version_id,
                compare_version_id: null,

                hideDoneComments: false,
                showEditLinks: false,
                isExplainVisible: true,

                time: 0,

                versions: [],
                comments: [],
                commentsLoading: true,
                commentSubmitting: false,

                add_comment: {
                    text: "",
                    author: "",
                    time: 0,
                    done: '0'
                }
            },
            computed: {
                player: function () { return this.$refs.player },
                compare_player: function () { return this.$refs.compare_player },

                version_src: function () { return this._get_attr(this.version_id,"url") },
                compare_version_src: function () { return this._get_attr(this.compare_version_id,"url") },

                version_code: function() {return this._get_version_code(this.version_id)},
                compare_version_code: function() {return this._get_version_code(this.compare_version_id)},
            },
            methods: {
                _get_version_code: function(version_id) {
                    return this.versions.map((v,index) => v.id == version_id ? index+1 : 0 ).filter(v=>v>0)[0]
                },
                _get_attr: function(version_id,attr) {
                    let version_or_undefined = this.versions.filter(v => v.id == version_id)
                    if(version_or_undefined[0] != undefined)
                        return version_or_undefined[0][attr]
                },
                formatTime: function (s) {
                    const zeroPad = (num, places) => String(num).padStart(places, '0')

                    let mins = zeroPad(Math.floor(s / 60), 2);
                    let secs = zeroPad(s % 60, 2);
                    return mins + ":" + secs;
                },
                toggle_done: function (comment) {
                    comment.done = comment.done == "1" ? "0" : "1";
                    fetch(api_url + comment.id + "/comments/", {
                        method: "put",
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                        body: JSON.stringify({ done: comment.done })
                    })
                },
                submit_comment: function () {

                    if (this.add_comment.text.length == 0)
                        alert("Bitte füllen Sie das Kommentarfeld aus.")
                    else if (this.add_comment.author.length == 0)
                        alert("Bitte geben Sie Ihren Namen ein.")
                    else {

                        this.commentSubmitting = true
                        fetch(api_url + this.version_id + "/comments/", {
                            method: "post",
                            headers: {
                                "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                            },
                            body: JSON.stringify({ ...this.add_comment, version_id:this.version_id })
                        })
                            .then(d => d.json())
                            .then(function () {
                                this.commentSubmitting = false
                                this.comments.push({ ...this.add_comment })
                                this.refreshComments()
                                this.add_comment.text = ""
                              
                                this.playVideo()

                            }.bind(this))
                            .catch(e => {
                                this.commentSubmitting = false
                                console.log("E", e);
                            })
                    }
                },
                refreshVersions: function () {
                    fetch(api_url + this.version_id + "/versions/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                        .then(d => d.json())
                        .then(d => {
                            if (d.data.length) this.versions = d.data;
                            this.setVersionId(this.version_id)
                         })
                },
                refreshComments: function () {
                    fetch(api_url + this.version_id + "/comments/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                        .then(d => d.json())
                        .then(d => { this.commentsLoading = false; if (d.data == undefined) this.comments=[]; else this.comments = d.data; this.sortComments() })
                },
                updateTime: function () {
                    this.time = parseInt(this.player.currentTime) | 0

                    if (this.add_comment.text === "")
                        this.add_comment.time = this.time
                },
                seekTo: function (time) {
                    this.player.currentTime=time
                    this.player.play()
                    //if(this.compare_version_id)
                        //this.compare_player.currentTime=time
                },
                stopVideo: function () {
                    this.player.pause()
                    //if(this.compare_version_id)
                        //this.compare_player.pause()
                },
                playVideo: function() {
                    this.player.play()
                    //if (this.compare_version_id)
                        //this.compare_player.play()
                },
                sortComments: function () {
                    if (this.comments != undefined)
                        this.comments = this.comments.sort((a, b) => parseInt(a.time) < parseInt(b.time) ? -1 : 1)
                },
                setCompareVersionId: function (version_id) {
                    this.compare_version_id = version_id
                    this.compare_player.load()
                    this.seekTo(this.player.currentTime)
                    this.playVideo()
                },
                setVersionId: function (version_id) {
                    this.version_id = version_id
                    this.refreshComments()   
                    this.player.load()
                    this.player.play()
                }
            },
            mounted: function () {
                this.refreshVersions()
                setInterval(this.updateTime, 500)

            }
        })
      
    </script>

    <style>

.fa.fa-times.close {margin:0px; font-size:1.4em;cursor:pointer;transition:.2s;opacity:.8;padding:15px;float: right; }
.fa.fa-times.close:hover {transform:scale(1.1) rotate(90deg);opacity:1}
        #nav-top.is-dark {
            background: rgba(0, 0, 0, .8);
            box-shadow: none;
        }

        #logo-anim {
            height: 3rem;
            margin: .4em 0;
        }

        #nav-top {
            box-shadow: 0 0 30px -15px rgba(0, 0, 0, .3);
            font-size: 1.3rem;
            z-index: 101;
            top: 0;
            background: rgba(255, 255, 255, .8);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            left: 0;
            right: 0;
            transition: .4s;
        }

        .nav-left #logo-anim {
            width: 55px;
            height: 55px;
            transition: .4s;
            border-radius: 50%;
        }

        #nav-top.is-dark .nav-logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }

        .nav-logo-text {
            margin-left: 1rem;
        }

        #nav-top.is-dark .nav-logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }

        #nav-top.is-dark .nav-logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }

        logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }

        #nav-top a.active,
        #nav-top a:not(.nolink):active,
        #nav-top a:not(.nolink):hover,
        .text ol p {
            color: #777;
            transition: background-color .1s, color .1s;
            text-decoration: none;
        }

        #nav-top.is-dark a:not(.nolink) {
            color: #ddd;
        }

        #nav-top a:not(.nolink) {
            padding: .4em 1em;
            transition: background-color .4s, color .4s;
            color: #333;
        }

        #nav-top a.active,
        #nav-top a:not(.nolink):active,
        #nav-top a:not(.nolink):hover,
        .text ol p {
            color: #777;
            transition: background-color .1s, color .1s;
            text-decoration: none;
        }

        #nav-top a:not(.nolink):hover,
        .text ol p {
            color: #777;
            transition: background-color .1s, color .1s;
            text-decoration: none;
        }

        #nav-top a {
            text-decoration: none;
        }

        #nav-top a:not(.nolink) {
            padding: .4em 1em;
            transition: background-color .4s, color .4s;
            color: #333;
        }

        #nav-top .nav-right {
            margin-right: 1em;
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .container {
            margin: auto;
            max-width: 1240px;
            width: 100%;
            width: auto;
            padding: 0 1em;
            display: flex
        }

        * {
            font-weight: 100;
            font-family: "Rubik"
        }

        .nav-left {
            align-items: center;
            display: flex;
        }

        .nav-left:hover #logo-anim {
            filter: invert(100%);
            transform: rotate(-180deg);
        }

        .row {
            display: flex
        }

        .o5 {
            opacity: .5;
        }

        .o5-hover {
            opacity: .6;
            color: white;
            transition: .1s;
        }

        .o5-hover:hover {
            opacity: 1;
            color: white
        }

        h4 {
            margin: 0
        }

        table {
            margin: 0
        }

        table tr td {
            border: none;
            border-top: 1px solid #0005;
        }

        .card-comments>div,
        .card-body.border-top {
            border-top: 2px solid #0005 !important;
        }

        .d-inline-block {
            display: inline-block;
            width: 100px
        }

        .card {
            margin-bottom: .5em
        }

        .form-control {}

        tr.active {
            background: #3dd5f3;
        }

        tr.active td {
            font-weight: bolder;
            color: #333
        }

        .has-i {
            display: block
        }

        .link {
            cursor: pointer;
        }

        #player {
            border-radius: .25rem;
            border-radius: 0;
        }

        @media (min-width:992px) {
            .sticky-desktop {
                position: sticky;
                top: 10px;
            }
        }

        body {
            background: rgb(31, 31, 31);
        }

        .card {
            box-shadow: 0;
            border: none
        }

        .card,
        .card table {
            background: #444;
            color: #eee;

        }

        .card table td a {
            color: #3dd5f3;
        }

        .explain {
            border-top: 5px solid #25cff2dd;
            background-color: #94c8c844;
            border-radius: .25rem;
            margin-bottom: 1em;
            color: white;
            padding-top: .4em;
        }

        .explain .card-body.border-top {
            border-color: #fff3 !important;
            margin: 0 .75em;
            margin-bottom: .75em;
            padding: 10px 0;
            color: #eee;
        }

        table tr:not(.active):hover {
            background: #b4cccc11;
            transition: .1s
        }

        .link {
            text-decoration: none;
            transition: .17s
        }

        .link:hover {
            color: white
        }

        .truetype {
            font-family: monospace;
            font-size: 1.3rem
        }

        @font-face {
            font-family: Rubik;
            src: url('Rubik-Medium-ee64fb9d3f1ba2333e1b489283925bce.ttf');
        }


        .card,
        .explain {
            border-radius: 0;
        }

        .explain {
            max-width: 1210px;
            margin: 20px 10px;
        }

        .btn.btn-primary-outline:hover {
            background: rgba(0, 0, 0, .06666666666666667);
        }

        .btn.btn-primary-outline {
            border: 2px solid #444;
        }

        :active,
        a:hover {
            outline-width: 0;
        }

        .mt-2 {
            margin-top: 20px !important;
        }

        .form-control {
            border-width: 2px;
            border: none;
            opacity: .9;
        }

        .form-control:focus {
            opacity: 1;
        }

        .form-control,
        .badge,
        .btn {
            padding: .4em .8em;
            border-radius: 8px;
            margin-right: .2em;
            box-shadow: none;
            display: inline-block;
            transition: .0s;
        }

        .badge,
        .btn {
            cursor: pointer;
        }

        .btn.btn-info {
            background: #444;
            border-width: 2px;
            color: #25cff2;
        }

        .btn.btn-info:hover {
            background: #333;
        }

        .btn.btn-info:active {
            filter: brightness(95%)
        }

        #comment-section .btn {
            margin-top: .5em;
            margin-left: 0
        }

        .btn.btn-primary {
            border: none;
            background: #00b0d3;
        } .compare_video_overlay {
            position: absolute;
            background: #0008;
            opacity: .9;
            color: white;
            padding: 0.4em 1em;
            transition:.3s;
        }

        #error {
            text-align: center;
            margin:60px auto;
            width:100%;
            padding:50px;
            background:#0004;
            padding-top:30px;
            border-radius:10px;
        }
        #error > *{
            color:white;
            margin:1em auto;
        }
    </style>
    
    
    </body>

</html>