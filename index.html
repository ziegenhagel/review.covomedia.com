<!DOCTYPE html>
<html>

<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.youtube.com/iframe_api"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <header id="nav-top" class="is-dark mobile-not-collapsed">
        <div class="container"><a class="nolink" href="/">
                <div class="nav-left">
                        <img id="logo-anim"
                            alt="Ziegenhagel Media Logo" src="https://ziegenhagel.com/static/logo-49a4d0c39260add115bae97c1fbb3196.jpg">
                    <div class="nav-logo-text">Ziegenhagel <span style="color: rgb(119, 119, 119);">Media</span></div>
                </div>
            </a>
            <div class="nav-hamburger">
                <div id="nav-icon2" class="closed">
                    <span></span><span></span><span></span><span></span><span></span><span></span></div>
            </div>
            <div class="nav-right"><a target="_blank" href="https://ziegenhagel.com/support">Support</a></div>
        </div>
    </header>

    <br>
    <div id="app" class="container">
        <div class="row" v-if="youtube_id">
            <div class="explain">
                <div class="card-body">
                    <h4>Feedback für Optimierungsschleifen </h4>
                </div>
                <div class="card-body border-top">
                    <i class="fa fa-info-circle"></i> Hier können Sie Versionen Ihres Films in
                    geschützter Umgebung einsehen und kommentieren.
                    Unser Team aus der Postproduktion wird Ihre Kommentare
                    aufgreifen und gewünschte Änderungen vornehmen.
                    <br><br>
                    <i class="fa fa-info-circle"></i> Auf der linken Seite befindet sich der Player, auf der rechten
                    Seite sehen Sie die Kommentarspalte.
                    Sobald Sie beginnen, einen neuen Kommentar zu schreiben,
                    wird dieser automatisch mit der richtigen Stelle im Video verlinkt.
                </div>
            </div>
            <div class="col">
                <div class="sticky-desktop">
                    <div id="player"></div>
                    <div id="info" class="card card-body has-i">
                        <h4><i class="fa fa-stopwatch"></i> Timecode: {{formatTime(time)}}</h4>
                    </div>
                    <div id="version-section" v-if="versions.length > 1" class="card">
                        <div class="card-body">
                            <h4> <i class="fa fa-history"></i> Versionen </h4>
                        </div>
                        <table class="table border-top">
                            <tr :class="version.youtube_id == currentYoutubeID ? 'active' : ''"
                                v-for="(version,index) in versions">
                                <td>Version {{index+1}} </td>
                                <td>{{version.changelog}}</td>
                                <td>
                                    <i class="o5" v-if="version.youtube_id == currentYoutubeID ? 'active' : ''">Aktuell
                                        ausgewählt</i>
                                    <a class="link" @click="setupYoutubeIDAgain(version.youtube_id)" v-else>Anschauen ›</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col">
                <div id="comment-section">
                    <div class="card">
                        <div class="card-body">
                            <h4> <i class="fa fa-comment"></i> Feedback </h4>
                        </div>
                        <div class="card-body border-top">
                            <div style="margin-bottom:10px"> Kommentar bei <span
                                    class="truetype">{{formatTime(add_comment.time)}}</span> im Video hinterlassen.
                            </div>
                            <textarea autofocus="autofocus" :disabled="commentSubmitting" v-model="add_comment.text" class="form-control" v-on:keyup="stopVideo"
                                placeholder="Kommentar zu aktueller Video Stelle eingeben"></textarea>
                            <input v-model="add_comment.author" :disabled="commentSubmitting" class="form-control" placeholder="Ihr Name">
                            <button @click="submit_comment" :class="commentSubmitting ? 'btn btn-primary disabled':'btn btn-primary'"> 
                                <span class="spinner-border spinner-border-sm" v-if="commentSubmitting" role="status" aria-hidden="true"></span>
                                Kommentar speichern <i
                                    class="fa fa-chevron-right"></i></button>
                        </div>

                    </div>

                    <div class="card card-comments">
                        <div class="card-body">
                            <h4> <i class="fa fa-list"></i> Kommentare </h4>
                        </div>
                        <div v-if="commentsLoading" style="margin:100px auto">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                              </div>
                        </div>
                        <div v-else :class="comment.done == '1' ? ' bg-success text-white' : ''" v-for="comment in comments"
                            v-if="comment.done == '0' || !hideDoneComments">
                            <div class="card-body">
                                <p class="card-text">
                                    <span v-if="comment.author.length > 1"><i class="fa fa-at"></i>
                                        <b>{{comment.author}}</b> -</span>
                                    {{comment.text}}
                                </p>
                                <button @click="seekTo(comment.time)" class="btn btn-info"><i class="fa fa-share"></i>
                                    Zu
                                    {{formatTime(comment.time)}}
                                    springen</button>
                                <button v-if=" showEditLinks && comment.done == '0' && comment.id" @click="toggle_done(comment)"
                                    class="btn btn-success"><i class="fa fa-check"></i> Als Fertig markieren</button>
                            </div>
                        </div>
                        <div class="card-footer row">

                            <a style="cursor:pointer;text-decoration:none" class="o5-hover" @click="hideDoneComments=!hideDoneComments"> <i :class="!hideDoneComments ? 'fa fa-eye-slash':'fa fa-eye'"></i> {{hideDoneComments ? "Zeige "+comments.filter(c=>c.done=='1').length + " fertige Kommentare an" : "Alle fertigen Kommentare ausblenden"}}</a>
                            <a style="cursor:pointer;text-decoration:none" class="o5-hover" @click="showEditLinks=!showEditLinks"> 
                                <i :class="showEditLinks ? 'fa fa-eye-slash':'fa fa-eye'"></i> 
                                {{!showEditLinks ? "Bearbeitung einblenden" : "Bearbeitung ausblenden"}}</a>

                        </div>
                    </div>
                    <br>
                    <br>

                </div>
            </div>
        </div>
        <div v-else class="card card-body">
            <h1>Youtube Video für das Review angeben</h1>
            <div style="margin:20px 0">
                Dort finden Sie die Youtube ID: <br><img
                    src="https://camo.githubusercontent.com/78e1ba6715553b6712b68ebbb3f520ddfa0b5e7c24801dd9901a5c3ba1d8211f/687474703a2f2f692e696d6775722e636f6d2f4f6c776b3463722e706e67"
                    width="400">
            </div>
            <form>
                Bitte geben Sie die Youtube ID ein:
                <input name="youtube_id" placeholder="Youtube ID" class="form-control"><br>
                <input type="submit" class="btn btn-primary" value="Zum Review">
            </form>
        </div>
    </div>

    <style>
        #nav-top.is-dark {
            background: rgba(0, 0, 0, .8);
            box-shadow: none;
        }
    
        #logo-anim {
            height: 3rem;
            margin: .4em 0;
        }
    
        #nav-top {
            box-shadow: 0 0 30px -15px rgba(0, 0, 0, .3);
            font-size: 1.3rem;
            z-index: 101;
            top: 0;
            background: rgba(255, 255, 255, .8);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            left: 0;
            right: 0;
            transition: .4s;
        }
    
        .nav-left #logo-anim {
            width: 55px;
            height: 55px;
            transition: .4s;
            border-radius: 50%;
        }
    
        #nav-top.is-dark .nav-logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }
    
        .nav-logo-text {
            margin-left: 1rem;
        }
    
        #nav-top.is-dark .nav-logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }
    
        #nav-top.is-dark .nav-logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }
    
        logo-text,
        #nav-top.is-dark a.active,
        #nav-top.is-dark a:not(.nolink):active,
        #nav-top.is-dark a:not(.nolink):hover {
            color: #fff;
        }
    
        #nav-top a.active,
        #nav-top a:not(.nolink):active,
        #nav-top a:not(.nolink):hover,
        .text ol p {
            color: #777;
            transition: background-color .1s, color .1s;
            text-decoration: none;
        }
    
        #nav-top.is-dark a:not(.nolink) {
            color: #ddd;
        }
    
        #nav-top a:not(.nolink) {
            padding: .4em 1em;
            transition: background-color .4s, color .4s;
            color: #333;
        }
    
        #nav-top a.active,
        #nav-top a:not(.nolink):active,
        #nav-top a:not(.nolink):hover,
        .text ol p {
            color: #777;
            transition: background-color .1s, color .1s;
            text-decoration: none;
        }
    
        #nav-top a:not(.nolink):hover,
        .text ol p {
            color: #777;
            transition: background-color .1s, color .1s;
            text-decoration: none;
        }
    
        #nav-top a {
            text-decoration: none;
        }
    
        #nav-top a:not(.nolink) {
            padding: .4em 1em;
            transition: background-color .4s, color .4s;
            color: #333;
        }
    
        #nav-top .nav-right {
            margin-right: 1em;
            margin-left: auto;
            display: flex;
            align-items: center;
        }
    
        .container {
            margin: auto;
            max-width: 1240px;
            width: 100%;
            width: auto;
            padding: 0 1em;
            display: flex
        }
    
        * {
            font-weight: 100;
            font-family: "Rubik"
        }
    
        .nav-left {
            align-items: center;
            display: flex;
        }
    
        .nav-left:hover #logo-anim {
            filter: invert(100%);
            transform: rotate(-180deg);
        }
    
        .row {
            display: flex
        }
    
        .o5 {
            opacity: .5;
        }
    
        .o5-hover {
            opacity: .6;
            color: white;
            transition: .1s;
        }
    
        .o5-hover:hover {
            opacity: 1;
            color: white
        }
    
        h4 {
            margin: 0
        }
    
        table {
            margin: 0
        }
    
        table tr td {
            border: none;
            border-top: 1px solid #0005;
        }
    
        .card-comments>div,
        .card-body.border-top {
            border-top: 2px solid #0005 !important;
        }
    
        .d-inline-block {
            display: inline-block;
            width: 100px
        }
    
        .card {
            margin-bottom: .5em
        }
    
        .form-control {
        }
    
        tr.active {
            background: #3dd5f3;
        }
    
        tr.active td {
            font-weight: bolder;
            color: #333
        }
    
        .has-i {
            display: block
        }
        .link{cursor: pointer;}
    
        #player {
            border-radius: .25rem;
            border-radius: 0;
        }
    
        @media (min-width:992px) {
            .sticky-desktop {
                position: sticky;
                top: 10px;
            }
        }
    
        body {
            background: rgb(31, 31, 31);
        }
    
        .card {
            box-shadow: 0;
            border: none
        }
    
        .card,
        .card table {
            background: #444;
            color: #eee;
    
        }
    
        .card table td a {
            color: #3dd5f3;
        }
    
        .explain {
    
            background-color: #b4cccc;
            border-radius: .25rem;
            margin-bottom: 1em
        }
    
        table tr:not(.active):hover {
            background: #b4cccc11;
            transition: .1s
        }
    
        .link {
            text-decoration: none;
            transition: .17s
        }
    
        .link:hover {
            color: white
        }
    
            .truetype {
            font-family: monospace;
            font-size: 1.3rem
        }
    
        @font-face {
            font-family: Rubik;
            src: url('Rubik-Medium-ee64fb9d3f1ba2333e1b489283925bce.ttf');
        }
    
    
        .card,
        .explain {
            border-radius: 0;
        }
    
        .btn.btn-primary-outline:hover {
            background: rgba(0, 0, 0, .06666666666666667);
        }
    
        .btn.btn-primary-outline {
            border: 2px solid #444;
        }
    
        :active,
        a:hover {
            outline-width: 0;
        }
    
        .mt-2 {
            margin-top: 20px !important;
        }
    
    .form-control {
        border-width: 2px;
        border:none;
        opacity: .9;
    }
    .form-control:focus {
        opacity: 1;
    }
    .form-control,
        .badge,
        .btn {
            padding: .4em .8em;
            border-radius: 8px;
            margin-right: .2em;
            box-shadow: none;
            display: inline-block;
            transition: .0s;
        }
        .badge,
        .btn {
            cursor: pointer;
        } .btn.btn-info {
            background:#444;
            border-width: 2px;
            color:#25cff2;
        } .btn.btn-info:hover {
            background:#333;
        } .btn.btn-info:active {
            filter:brightness(95%)
        }
        #comment-section .btn {
            margin-top:.5em;
            margin-left:0
        }
    </style>

    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        const api_url = "https://api.covomedia.com/plug-review/"
        let youtube_id = urlParams.get("youtube_id")

        var player;

        var app = new Vue({
            el: '#app',
            data: {
                hideDoneComments: false,
                currentYoutubeID: youtube_id,
                showEditLinks: false,
                commentSubmitting : false,
                time: 0,
                comments: [],
                commentsLoading:true,
                versions: [],
                add_comment: {
                    text: "",
                    author: "",
                    time: 0,
                    done: '0'
                }
            },
            computed: {
                youtube_id: function () { return youtube_id }
            },
            methods: {
                formatTime: function (s) {
                    const zeroPad = (num, places) => String(num).padStart(places, '0')

                    let mins = zeroPad(Math.floor(s / 60), 2);
                    let secs = zeroPad(s % 60, 2);
                    return mins + ":" + secs;
                },
                toggle_done: function (comment) {
                    comment.done = comment.done == "1" ? "0" : "1";
                    fetch(api_url + youtube_id + "/comments/" + comment.id, {
                        method: "put",
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                        body: JSON.stringify({ done: comment.done })
                    })
                },
                submit_comment: function () {
                    this.commentSubmitting = true

                    if(this.add_comment.text.length == 0)
                        alert("Bitte füllen Sie das Kommentarfeld aus.")
                    else if(this.add_comment.author.length == 0)
                        alert("Bitte geben Sie Ihren Namen ein.")
                    else

                    fetch(api_url + youtube_id + "/comments/", {
                        method: "post",
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                        body: JSON.stringify({ ...this.add_comment, youtube_id })
                    })
                        .then(d => d.json())
                        .then(function () {
                            this.commentSubmitting = false
                            this.comments.push({ ...this.add_comment })
                            this.sortComments()
                            this.add_comment.text = ""
                        }.bind(this))
                        .catch(e => {
                            this.commentSubmitting = false
                            console.log("E", e);
                        })
                },
                refreshVersions: function () {
                    fetch(api_url + youtube_id + "/versions/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                        .then(d => d.json())
                        .then(d => { console.log(d); if (d.data.length) this.versions = d.data; })
                },
                refreshComments: function () {
                    fetch(api_url + youtube_id + "/comments/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                        .then(d => d.json())
                        .then(d => {this.commentsLoading = false;if(d.data == undefined) return; this.comments = d.data; this.sortComments() })
                },
                updateTime: function () {
                    this.time = parseInt(player.playerInfo.currentTime) | 0

                    if (this.add_comment.text === "")
                        this.add_comment.time = this.time
                },
                seekTo: function (time) {
                    player.seekTo(time, true);
                    player.playVideo()
                },
                stopVideo: function () {
                    //player.stopVideo()
                },
                sortComments: function () {
                    if (this.comments != undefined)
                        this.comments = this.comments.sort((a, b) => a.time < b.time)
                },
                setupYoutubeIDAgain: function (some_id) {
                    youtube_id = some_id;
                    player.loadVideoById(youtube_id);
                    this.commentsLoading = true
                    this.refreshComments()
                    this.currentYoutubeID = some_id
                }
            },
            mounted: function () {
                this.refreshComments()
                this.refreshVersions()
                setInterval(this.updateTime, 500)
            }
        })

        function onYouTubeIframeAPIReady() {
            console.log("Create Youtube Playert");

            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: youtube_id,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                },
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'fs': 0,
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }


        var done = false;
        function onPlayerStateChange(event) {
            /*
            if (event.data == YT.PlayerState.PLAYING && !done) {
              setTimeout(stopVideo, 6000);
              done = true;
            }
            */
        }
        function stopVideo() {
            player.stopVideo();
        }


    </script>
</body>

</html>