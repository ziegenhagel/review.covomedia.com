<!DOCTYPE html>
<html>

<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <br>
    <div id="app" class="container">
        <div class="row" v-if="youtube_id">
            <div class="explain">
                <div class="card-body">
                    <h4>Feedback für Optimierungsschleifen </h4>
                </div>
                <div class="card-body border-top">
                    <i class="fa fa-info-circle"></i> Hier können Sie Versionen Ihres Films in
                    geschützter Umgebung einsehen und kommentieren.
                    Unser Team aus der Postproduktion wird Ihre Kommentare
                    aufgreifen und gewünschte Änderungen vornehmen.
                    <br><br>
                    <i class="fa fa-info-circle"></i> Auf der linken Seite befindet sich der Player, auf der rechten
                    Seite sehen Sie die Kommentarspalte.
                    Sobald Sie beginnen, einen neuen Kommentar zu schreiben,
                    wird dieser automatisch mit der richtigen Stelle im Video verlinkt.
                </div>
            </div>
            <div class="col">
                <div class="sticky-desktop">
                    <div id="player"></div>
                    <div id="info" class="card card-body has-i">
                        <h4><i class="fa fa-stopwatch"></i> Timecode: {{formatTime(time)}}</h4>
                    </div>
                    <div id="version-section" v-if="versions.length > 1" class="card">
                        <div class="card-body">
                            <h4> <i class="fa fa-history"></i> Versionen </h4>
                        </div>
                        <table class="table border-top">
                            <tr :class="version.youtube_id == youtube_id ? 'active' : ''"
                                v-for="(version,index) in versions">
                                <td>Version {{index+1}} </td>
                                <td>{{version.changelog}}</td>
                                <td>
                                    <i class="o5" v-if="version.youtube_id == youtube_id ? 'active' : ''">Aktuell
                                        ausgewählt</i>
                                    <a class="link" :href="'?youtube_id='+version.youtube_id" v-else>Anschauen</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col">
                <div id="comment-section">
                    <div class="card">
                        <div class="card-body">
                            <h4> <i class="fa fa-comment"></i> Feedback </h4>
                        </div>
                        <div class="card-body border-top">
                            <div style="margin-bottom:10px"> Kommentar bei <span
                                    class="truetype">{{formatTime(add_comment.time)}}</span> im Video hinterlassen.
                            </div>
                            <textarea v-model="add_comment.text" class="form-control" v-on:keyup="stopVideo"
                                placeholder="Kommentar zu aktueller Video Stelle eingeben"></textarea>
                            <input v-model="add_comment.author" class="form-control" placeholder="Ihr Name">
                            <button @click="submit_comment" class="btn btn-primary"> Kommentar speichern <i
                                    class="fa fa-chevron-right"></i></button>
                        </div>

                    </div>

                    <div class="card card-comments">
                        <div class="card-body">
                            <h4> <i class="fa fa-list"></i> Kommentare </h4>
                        </div>
                        <div :class="comment.done == '1' ? ' bg-success text-white' : ''" v-for="comment in comments"
                            v-if="comment.done == '0' || !hideDoneComments">
                            <div class="card-body">
                                <p class="card-text">
                                    <span v-if="comment.author.length > 1"><i class="fa fa-at"></i>
                                        <b>{{comment.author}}</b> -</span>
                                    {{comment.text}}
                                </p>
                                <button @click="seekTo(comment.time)" class="btn btn-info"><i class="fa fa-share"></i>
                                    Zu
                                    {{formatTime(comment.time)}}
                                    springen</button>
                                <button v-if="comment.done == '0' && comment.id" @click="toggle_done(comment)"
                                    class="btn btn-success"><i class="fa fa-check"></i> Als Fertig markieren</button>
                            </div>
                        </div>
                        <div class="card-footer">

                            <a style="cursor:pointer;text-decoration:none" class="o5-hover"
                                @click="hideDoneComments=!hideDoneComments">
                                <i :class="!hideDoneComments ? 'fa fa-eye-slash':'fa fa-eye'"></i>
                                {{hideDoneComments ? "Zeige "+comments.filter(c=>c.done=='1').length + " fertige
                                Kommentare an"
                                : "Alle fertigen Kommentare ausblenden"}}</a>
                        </div>
                    </div>
                    <br>
                    <br>

                </div>
            </div>
        </div>
        <div v-else class="card card-body">
            <h1>Youtube Video für das Review angeben</h1>
            <div style="margin:20px 0">
                Dort finden Sie die Youtube ID: <br><img
                    src="https://camo.githubusercontent.com/78e1ba6715553b6712b68ebbb3f520ddfa0b5e7c24801dd9901a5c3ba1d8211f/687474703a2f2f692e696d6775722e636f6d2f4f6c776b3463722e706e67"
                    width="400">
            </div>
            <form>
                Bitte geben Sie die Youtube ID ein:
                <input name="youtube_id" placeholder="Youtube ID" class="form-control"><br>
                <input type="submit" class="btn btn-primary" value="Zum Review">
            </form>
        </div>
    </div>

    <style>
        .row {
            display: flex
        }

        .o5 {
            opacity: .5;
        }

        .o5-hover {
            opacity: .6;
            color: white;
            transition: .1s;
        }

        .o5-hover:hover {
            opacity: 1;
            color: white
        }

        h4 {
            margin: 0
        }

        table {
            margin: 0
        }

        table tr td {
            border: none;
            border-top: 1px solid #0005;
        }

        .card-comments>div,
        .card-body.border-top {
            border-top: 2px solid #0005 !important;
        }

        .d-inline-block {
            display: inline-block;
            width: 100px
        }

        .card {
            margin-bottom: .5em
        }

        .form-control {
            margin-bottom: .5em;
        }

        tr.active {
            background: #3dd5f3;
        }

        tr.active td {
            font-weight: bolder;
            color: #333
        }

        .has-i {
            display: block
        }

        #player {
            border-radius: .25rem;
        }

        @media (min-width:992px) {
            .sticky-desktop {
                position: sticky;
                top: 10px;
            }
        }

        body {
            background: rgb(31, 31, 31);
        }

        .card {
            box-shadow: 0;
            border: none
        }

        .card,
        .card table {
            background: #444;
            color: #eee;

        }

        .card table td a {
            color: #3dd5f3;
        }

        .explain {

            background-color: #b4cccc;
            border-radius: .25rem;
            margin-bottom: 1em
        }

        table tr:not(.active):hover {
            background: #b4cccc11;
            transition: .1s
        }

        .link {
            text-decoration: none;
            transition: .17s
        }

        .link:hover {
            color: white
        }


        .truetype {
            font-family: monospace;
            font-size: 1.3rem
        }
    </style>

    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        const api_url = "https://api.covomedia.com/plug-review/"
        let youtube_id = urlParams.get("youtube_id")

        var player;

        var app = new Vue({
            el: '#app',
            data: {
                hideDoneComments: false,
                time: 0,
                comments: [],
                versions: [],
                add_comment: {
                    text: "",
                    author: "",
                    time: 0,
                    done: '0'
                }
            },
            computed: {
                youtube_id: function () { return youtube_id }
            },
            methods: {
                formatTime: function (s) {
                    const zeroPad = (num, places) => String(num).padStart(places, '0')

                    let mins = zeroPad(Math.floor(s / 60), 2);
                    let secs = zeroPad(s % 60, 2);
                    return mins + ":" + secs;
                },
                toggle_done: function (comment) {
                    comment.done = comment.done == "1" ? "0" : "1";
                    fetch(api_url + youtube_id + "/comments/" + comment.id, {
                        method: "put",
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                        body: JSON.stringify({ done: comment.done })
                    })
                },
                submit_comment: function () {

                    fetch(api_url + youtube_id + "/comments/", {
                        method: "post",
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                        body: JSON.stringify({ ...this.add_comment, youtube_id })
                    })
                        .then(d => d.json())
                        .then(function () {
                            this.comments.push({ ...this.add_comment })
                            this.sortComments()
                            this.add_comment.text = ""
                        }.bind(this))
                        .catch(e => {
                            console.log("E", e);
                        })
                },
                refreshVersions: function () {
                    fetch(api_url + youtube_id + "/versions/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                        .then(d => d.json())
                        .then(d => { console.log(d); if (d.data.length) this.versions = d.data; })
                },
                refreshComments: function () {
                    fetch(api_url + youtube_id + "/comments/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                        .then(d => d.json())
                        .then(d => { this.comments = d.data; this.sortComments() })
                },
                updateTime: function () {
                    this.time = parseInt(player.playerInfo.currentTime) | 0

                    if (this.add_comment.text === "")
                        this.add_comment.time = this.time
                },
                seekTo: function (time) {
                    player.seekTo(time, true);
                    player.playVideo()
                },
                stopVideo: function () {
                    //player.stopVideo()
                },
                sortComments: function () {
                    this.comments = this.comments.sort((a, b) => a.time < b.time)
                }
            },
            mounted: function () {
                this.refreshComments()
                this.refreshVersions()
                setInterval(this.updateTime, 500)
            }
        })

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: youtube_id,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                },
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'fs': 0,
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }


        var done = false;
        function onPlayerStateChange(event) {
            /*
            if (event.data == YT.PlayerState.PLAYING && !done) {
              setTimeout(stopVideo, 6000);
              done = true;
            }
            */
        }
        function stopVideo() {
            player.stopVideo();
        }
    </script>
</body>

</html>