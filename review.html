<!DOCTYPE html>
<html>
    <head>
        <script src="https://www.youtube.com/iframe_api"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    </head>
  <body>

    <div id="app" class="container">
        <div class="row" v-if="youtube_id">
            <div class="col">
                <div id="player"></div>
                <div id="info">
                    Player time: {{time}}s
                </div>
            </div>
            <div class="col">
                <div id="comments">
                    Zeit: <input v-model="add_comment.time">s<br>
                    <textarea v-model="add_comment.text" placeholder="Bitte Nachricht eingeben"></textarea><br>
                    <input v-model="add_comment.author" placeholder="Ihr Name"><br>
                    <button @click="submit_comment">Kommentar speichern</button>
                    <hr>
                    <div :class="comment.done ? 'card bg-success text-white' : 'card'" v-for="comment in comments">
                        <div class="card-header">{{comment.author}}</div>
                        <div class="card-body">
                            <i class="card-title o5">Bei {{comment.time}}s</i>
                            <p class="card-text">{{comment.text}}</p>
                            <button @click="seekTo(comment.time)" class="btn btn-info">Anschauen</button>
                            <button v-if="!comment.done" @click="toggle_done(comment)" class="btn btn-success">Als Fertig markieren</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else>
            <h1>Video ID eingeben:</h1>
            <form>
                <input name="youtube_id" placeholder="Video ID" class="form-control">
                <input type="submit" value="Absenden">
            </form>

        </div>
    </div>

    <style>
        .row {display:flex} .o5 {opacity: .5;}
    </style>

    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        const api_url = "https://api.covomedia.com/plug_frameio/"
        const youtube_id = urlParams.get("youtube_id")
        var app = new Vue({
            el: '#app',
            data: {
                time: -1,
                comments: [],
                add_comment: {
                    text: "Lorem ipsu",
                    author: "Loui",
                    time: -1,
                    done: false
                }
            },
            computed: {
                youtube_id: function() {return youtube_id}
            },
            methods: {
                toggle_done: function(comment) {
                    comment.done = !comment.done
                },
                submit_comment: function() {

                    fetch(api_url,{
                        method: "post",
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                        body:JSON.stringify(this.add_comment)
                    })
                    .then(d=>d.json())
                    .then(d=>{
                        this.comments.push({ ...this.add_comment })
                        this.add_comment.text = ""
                    })
                    .catch(e=>{
                        alert("Fehler")
                        console.log("E",e);
                    })
                },
                refreshComments: function() {
                    fetch("https://api.covomedia.com/plug_frameio/", {
                        headers: {
                            "x-api-key": "4b9583cc-0861-4102-8eb4-663e603c"
                        },
                    })
                    .then(d=>d.json())
                    .then(d=>this.comments = d.data)
                },
                updateTime: function() {
                    this.time = parseInt(player.playerInfo.currentTime) | 0

                    if(this.add_comment.text === "")
                        this.add_comment.time = this.time
                },
                seekTo: function(time) {
                    player.seekTo(time,true); 
                }
            },
            mounted: function() {
                this.refreshComments()
                setInterval(this.updateTime,500)
            }
        })

      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '360',
          width: '640',
          videoId: youtube_id,
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        event.target.playVideo();
      }

      
      var done = false;
      function onPlayerStateChange(event) {
        /*
        if (event.data == YT.PlayerState.PLAYING && !done) {
          setTimeout(stopVideo, 6000);
          done = true;
        }
        */
      }
      function stopVideo() {
        player.stopVideo();
      }
    </script>
  </body>
</html>

